name: Build and Release

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ] # Triggers release flow when you push a tag like v1.0.0
  pull_request:
    branches: [ "main" ]

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup vcpkg
      run: |
        if (!(Test-Path "vcpkg")) {
          git clone https://github.com/microsoft/vcpkg.git
          ./vcpkg/bootstrap-vcpkg.bat
        }
      shell: pwsh

    - name: Install Dependencies via vcpkg
      run: |
        ./vcpkg/vcpkg install curl nlohmann-json --triplet x64-windows
      shell: pwsh
    
    #- name: Configure CMake
    # run: cmake -B build -S . -DCMAKE_TOOLCHAIN_FILE=vcpkg/scripts/buildsystems/vcpkg.cmake -DCMAKE_BUILD_TYPE=Release
    #  shell: pwsh

    - name: Configure CMake
      # 使用绝对路径 + 双引号，防止任何路径解析错误
      run: |
        cmake -B build -S . "-DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" -DCMAKE_BUILD_TYPE=Release
      shell: pwsh

    - name: Build Project
      run: cmake --build build --config Release
      shell: pwsh

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: StockMonitor-Windows
        path: build/Release/StockMonitor.exe

  create-release:
    needs: build-windows
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: StockMonitor-Windows

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: StockMonitor.exe
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}